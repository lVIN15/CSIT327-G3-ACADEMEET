{% extends 'base.html' %}
{% load static %}

{% block title %}Verify Code - Academeet{% endblock %}

{% block content %}
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>

    <a href="{% url 'role_selection' %}" class="back-link"> Back</a>

    <div class="container">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
            </div>
            <h1>Verify Code</h1>
            <p class="subtitle">Enter the 6-digit code sent to your email</p>
        </div>

    <div class="signup-form-container">
        <h2 class="form-title">Enter Verification Code</h2>
        <p class="note">A 6-digit code has been sent to your email{% if email %} ({{ email }}){% endif %}.</p>

            {% if error_message %}
                <p class="error-message" style="color: red; text-align: center;">{{ error_message }}</p>
            {% endif %}

            <form method="post" class="signup-form code-form" id="verificationForm">
                {% csrf_token %}
                {% if email %}<input type="hidden" name="email" value="{{ email }}">{% endif %}
                
                <div class="code-input-group">
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d1" required>
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d2" required>
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d3" required>
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d4" required>
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d5" required>
                    <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" class="code-input" id="d6" required>
                    <input type="hidden" id="confirmation_code_hidden" name="confirmation_code">
                </div>
                
                <button type="submit" class="login-btn" id="verifyBtn">Verify Code</button>
            </form>

            <form method="post" action="" class="signup-form resend-form" id="resendForm">
                {% csrf_token %}
                {% if email %}<input type="hidden" name="email" value="{{ email }}">{% endif %}
                <button id="resendBtn" class="login-btn resend-btn" type="submit">Resend code</button>
            </form>

            <div class="register-link">
                <p><a href="{% url 'role_selection' %}">Back to role selection</a></p>
            </div>
        </div>
    </div>

<style>
/* Basic styling for the code input boxes */
.code-input-group {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    gap: 8px; 
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
}
.code-input {
    width: 40px;
    height: 50px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    border: 1px solid #ccc;
    border-radius: 5px;
    outline: none;
    transition: border-color 0.2s;
}
.code-input:focus {
    border-color: #007bff;
}
.resend-form {
    margin-top: 15px;
}
.resend-btn {
    background-color: #6c757d; 
    transition: opacity 0.3s;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeInputs = document.querySelectorAll('.code-input');
    const fullCodeInput = document.getElementById('confirmation_code_hidden');
    const verificationForm = document.getElementById('verificationForm');
    const resendBtn = document.getElementById('resendBtn');
    
    // Cooldown duration is set to 60 seconds
    const cooldownDuration = 60; 
    // Initial remaining time comes from the backend context
    let remaining = parseInt("{{ cooldown_remaining|default:0 }}") || 0; 
    let timer = null;

    // --- Input Box & Validation Logic ---
    codeInputs.forEach((input, index) => {
        // Auto-focus to next box on single digit input
        input.addEventListener('input', function() {
            // Only allow digits
            if(!/^[0-9]$/.test(this.value)) { this.value = ''; return; }
            
            if (this.value.length === 1 && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }

            // Check if all boxes are filled and auto-submit
            let allFilled = true;
            codeInputs.forEach(box => { if(!box.value) allFilled = false; });
            if(allFilled){
                let code = '';
                codeInputs.forEach(box => code += box.value);
                fullCodeInput.value = code;
                // Auto-submit the form via AJAX
                verificationForm.dispatchEvent(new Event('submit'));
            }
        });
        // Backspace to previous field
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                codeInputs[index - 1].focus();
            }
        });
    });

    // Combine all 6 inputs into the hidden field before submission
    // Use a normal form submit so server-side redirect will be followed directly
    verificationForm.addEventListener('submit', function(e) {
        // Build the combined code value
        let code = '';
        codeInputs.forEach(input => {
            code += input.value;
        });
        fullCodeInput.value = code;

        // Validate locally first
        if (code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
            alert('Please enter a valid 6-digit numeric code.');
            codeInputs.forEach(input => input.value = '');
            codeInputs[0].focus();
            return;
        }

        console.log('[DEBUG] Submitting code (normal submit):', code);

        // Submit the form normally so the server can perform a redirect to the reset page
        // (This avoids the AJAX fetch path which can surface generic JS errors)
        verificationForm.submit();
    });

    // --- 60-Second Cooldown Timer Logic ---
    function renderTimer() {
        if (!resendBtn) return;
        if (remaining > 0) {
            resendBtn.disabled = true;
            resendBtn.style.opacity = '0.6';
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            // Display remaining time (e.g., 0:45)
            resendBtn.textContent = `Resend code in ${m}:${s < 10 ? '0' + s : s}`;
        } else {
            resendBtn.disabled = false;
            resendBtn.style.opacity = '1';
            resendBtn.textContent = 'Resend code';
        }
    }

    function startTimer(duration) {
        remaining = duration; // Reset the remaining time (60 seconds)
        if (timer) clearInterval(timer);
        timer = setInterval(function() {
            remaining -= 1;
            renderTimer();
            if (remaining <= 0) {
                clearInterval(timer);
                timer = null;
            }
        }, 1000);
    }

    // Start timer on page load (if time is remaining from the backend)
    if (remaining > 0) {
        startTimer(remaining);
    } else {
        renderTimer(); 
    }
    
    // Crucial: When the resend form is submitted, reset the timer visually
    const resendForm = document.getElementById('resendForm');
    if(resendForm) {
        resendForm.addEventListener('submit', function() {
            // This ensures immediate visual feedback to the user that the cooldown has reset
            startTimer(cooldownDuration); 
        });
    }
});
</script>
{% endblock %}